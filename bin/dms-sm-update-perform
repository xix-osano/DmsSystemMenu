#!/bin/bash

set -e

# Update Time
echo "Updating time..."
sudo systemctl restart systemd-timesyncd

# Update packages
echo -e "\e[32m\nUpdate system packages\e[0m"
sudo pacman -Syu --noconfirm

# Update AUR packages if any are installed
if pacman -Qem >/dev/null; then
  if dms-sm-pkg-aur-accessible; then
    echo -e "\e[32m\nUpdate AUR packages\e[0m"
    yay -Sua --noconfirm
    echo
  else
    echo -e "\e[31m\nAUR is unavailable (so skipping updates)\e[0m"
    echo
  fi
fi

orphans=$(pacman -Qtdq || true)
if [[ -n $orphans ]]; then
  echo -e "\e[32m\nRemove orphan system packages\e[0m"
  for pkg in $orphans; do
    sudo pacman -Rs --noconfirm "$pkg" || true
  done
  echo
fi

# After Update Restart
if [ "$(uname -r | sed 's/-arch/\.arch/')" != "$(pacman -Q linux | awk '{print $2}')" ]; then
  gum confirm "Linux kernel has been updated. Reboot?" && sudo reboot now


