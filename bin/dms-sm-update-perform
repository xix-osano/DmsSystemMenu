#!/bin/bash

set -euo pipefail
IFS=$'\n\t'

# Update Time
echo "Updating time..."
sudo systemctl restart systemd-timesyncd

# Update packages
echo -e "\e[32m\nUpdate system packages\e[0m"
sudo pacman -Syu --noconfirm

# Update AUR packages if any are installed
if pacman -Qem >/dev/null 2>&1; then
  if command -v dms-sm-pkg-aur-accessible >/dev/null 2>&1 && dms-sm-pkg-aur-accessible; then
    echo -e "\e[32m\nUpdate AUR packages\e[0m"
    if command -v yay >/dev/null 2>&1; then
      yay -Sua --noconfirm
    elif command -v paru >/dev/null 2>&1; then
      paru -Sua --noconfirm
    else
      echo -e "\e[31m\nNo AUR helper found; skipping AUR updates\e[0m"
    fi
    echo
  else
    echo -e "\e[31m\nAUR is unavailable (so skipping updates)\e[0m"
    echo
  fi
fi

# Remove orphaned packages (if any)
mapfile -t orphans < <(pacman -Qtdq 2>/dev/null || true)
if (( ${#orphans[@]} )); then
  echo -e "\e[32m\nRemove orphan system packages\e[0m"
  for pkg in "${orphans[@]}"; do
    sudo pacman -Rs --noconfirm "$pkg" || true
  done
  echo
fi

# After Update Restart
# Compare installed linux package version with running kernel.
installed_linux_ver=$(pacman -Q linux 2>/dev/null | awk '{print $2}' || true)
running_kernel_ver=$(uname -r | sed 's/-arch/\.arch/')

if [[ -n "$installed_linux_ver" && "$running_kernel_ver" != "$installed_linux_ver" ]]; then
  if command -v gum >/dev/null 2>&1; then
    gum confirm "Linux kernel has been updated. Reboot?" && sudo reboot now
  else
    read -r -p "Linux kernel has been updated. Reboot? [y/N] " ans
    if [[ "$ans" =~ ^[Yy]$ ]]; then
      sudo reboot now
    fi
  fi
fi

