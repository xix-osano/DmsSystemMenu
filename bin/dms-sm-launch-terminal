#!/bin/bash

# dms-sm-launch-terminal #Floating terminal
# Usage:
#  dms-sm-launch-terminal [terminal]
# If -- is not provided, the script falls back to using alacritty.

# find separator index
sep_index=0
idx=1
for a in "$@"; do
	if [ "$a" = "--" ]; then
		sep_index=$idx
		break
	fi
	idx=$((idx+1))
done

if [ $sep_index -ne 0 ]; then
	# terminal command is $1 .. $(sep_index-1)
	term_cmd=( "${@:1:sep_index-1}" )
	inner_cmd=( "${@:sep_index+1}" )
else
	# fallback: use alacritty and treat all args as the inner command
	term_cmd=( alacritty )
	inner_cmd=( "$@" )
fi

if [ ${#inner_cmd[@]} -eq 0 ]; then
	# nothing to run inside the terminal
	exec setsid "${term_cmd[@]}" -e bash -c "dms-sm-show-logo; dms-sm-show-done"
fi

# Join inner command safely for bash -c
inner_joined=""
for arg in "${inner_cmd[@]}"; do
	inner_joined+="$(printf '%q' "$arg") "
done
inner_joined=${inner_joined% }

# Launch terminal: many terminals accept -e (or similar) to run a program.
# We apply terminal-specific flags where known, try the primary terminal,
# and fall back to alacritty or a shell invocation on failure.

# helper to try launching and return 0 on success
try_launch() {
	local -n _cmd=$1
	if ! command -v "${_cmd[0]}" >/dev/null 2>&1; then
		return 1
	fi
	setsid "${_cmd[@]}" >/dev/null 2>&1 &
	sleep 0.05
	# If setsid returned successfully we assume it started
	return $?
}

# decide flags based on terminal program basename
term_prog="$(basename "${term_cmd[0]}")"
term_flags=()
exec_prefix=()
case "$term_prog" in
	alacritty)
		term_flags+=("--class=DMS_SM" "--title=DMS_SM")
		exec_prefix=("-e" "bash" "-c")
		;;
	kitty)
		# kitty supports --class via window title config; use --title and -e
		term_flags+=("--title" "DMS_SM")
		exec_prefix=("-e" "bash" "-c")
		;;
	foot)
		# foot uses -e
		exec_prefix=("-e" "bash" "-c")
		;;
esac

# Build command array to try
cmd_try=( "${term_cmd[@]}" )
if [ ${#term_flags[@]} -gt 0 ]; then
	cmd_try+=( "${term_flags[@]}" )
fi
cmd_try+=( "${exec_prefix[@]}" "dms-sm-show-logo; ${inner_joined}; dms-sm-show-done" )

if try_launch cmd_try; then
	exit 0
fi

# Primary failed: try fallback to alacritty if available
if command -v alacritty >/dev/null 2>&1; then
	setsid alacritty --class=DMS_SM --title=DMS_SM -e bash -c "dms-sm-show-logo; ${inner_joined}; dms-sm-show-done" >/dev/null 2>&1 &
	exit 0
fi
