#!/bin/bash

# Install Docker
dms-sm-pkg-add docker docker-buildx docker-compose

# Configure Docker daemon
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json >/dev/null <<'EOF'
{
    "log-driver": "json-file",
    "log-opts": { "max-size": "10m", "max-file": "5" },
    "dns": ["172.17.0.1"],
    "bip": "172.17.0.0/16"
}
EOF

# DNS for containers via systemd-resolved
sudo mkdir -p /etc/systemd/resolved.conf.d
echo -e '[Resolve]\nDNSStubListenerExtra=172.17.0.1' \
  | sudo tee /etc/systemd/resolved.conf.d/20-docker-dns.conf >/dev/null

sudo systemctl restart systemd-resolved

# Start Docker automatically
sudo systemctl enable docker

# Privileged Docker access for this user
sudo usermod -aG docker "$USER"

# Make sure Docker doesn't block boot
sudo mkdir -p /etc/systemd/system/docker.service.d
sudo tee /etc/systemd/system/docker.service.d/no-block-boot.conf >/dev/null <<'EOF'
[Unit]
After=network-online.target
Wants=network-online.target
EOF

sudo systemctl daemon-reload
